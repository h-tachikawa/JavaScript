version: 2.1
executors:
  default:
    working_directory: ~/repo
    docker:
      - image: circleci/ruby:2.4.1-node-browsers
        environment:
          BUNDLE_JOBS: 3
          BUNDLE_RETRY: 3
          BUNDLE_PATH: vendor/bundle
          RAILS_ENV: test
          NODE_ENV: development
          AWS_ACCESS_KEY_ID: access_key_id
          AWS_SECRET_KEY: secret_key
          AWS_REGION: ap-northeast-1
          AWS_S3_BUCKET: resily
          AWS_S3_URL: http://127.0.0.1:9000/
          MINIO_HOST: minio
          MINIO_ENDPOINT: http://minio:9000
          RAILS_DATABASE_HOST: db
          RAILS_DATABASE_PASSWORD: password
          RAILS_REDIS_HOST: redis
      - image: mysql:5.7
        name: db
        environment:
          MYSQL_ROOT_PASSWORD: password
      - image: redis:3.2
        name: redis
      - image: blueimp/mailhog:latest
      - image: minio/minio:latest
        name: minio
        environment:
          MINIO_ACCESS_KEY: access_key_id
          MINIO_SECRET_KEY: secret_key
          MINIO_REGION: ap-northeast-1
        command: ["server", "/data"]
  deploy:
    working_directory: ~/repo
    docker:
      - image: circleci/python:3.6.4
jobs:
  test:
    executor:
      name: default
    steps:
      - checkout
      - run:
          name: Which bundler?
          command: bundle -v
      - restore_cache:
          keys:
          - dependencies-{{ checksum "Gemfile.lock" }}
          # fallback to using the latest cache if no exact match is found
          - dependencies-
      - run:
          name: Bundle Install
          command: bundle check || bundle install
      - save_cache:
          paths:
            - vendor/bundle
          key: dependencies-{{ checksum "Gemfile.lock" }}
      - run:
          name: Install minio client, prepare minio
          command: |
            curl -sSL https://dl.minio.io/client/mc/release/linux-amd64/mc -o /tmp/mc
            chmod +x /tmp/mc

            /tmp/mc config host add minio http://minio:9000 access_key_id secret_key S3v4
            /tmp/mc mb --region ap-northeast-1 minio/resily
            /tmp/mc policy download minio/resily
      - run: bundle exec rake db:create
      - run: bundle exec rake db:schema:load --trace
      - run:
          name: Run tests
          command: |
            bundle exec rspec --profile 10 \
                              --format RspecJunitFormatter \
                              --out test-results/rspec.xml \
                              --format progress \
                              $(circleci tests glob "spec/**/*_spec.rb" | circleci tests split --split-by=timings)
      - run:
          name: Generate API Documente
          command: |
            bundle exec rake docs:generate:ordered
      # collect reports
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: docs/api
  deploy:
    parameters:
      env:
        type: enum
        enum: ["develop", "production"]
    executor:
      name: deploy
    steps:
      - checkout
      - run:
          name: Install awscli
          command: |
            sudo pip install awsebcli --upgrade
      - run:
          name: Deploy to << parameters.env >>
          command: eb deploy << parameters.env >> --timeout 25
workflows:
  test-and-deploy:
    jobs:
      - test
      - deploy:
          name: deploy-to-develop
          env: develop
          requires:
            - test
          filters:
            branches:
              only: master
      - deploy:
          name: deploy-to-production
          env: production
          requires:
            - test
          filters:
            tags:
              only: /.*/
            branches:
              ignore: /.*/
